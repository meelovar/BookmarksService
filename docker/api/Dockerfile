FROM python:3.12-slim as base

ARG USER_ID=10001
ARG USER_NAME=py-user
ARG USER_HOME=/home/$USER_NAME

ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1


RUN useradd -d $USER_HOME -u $USER_ID $USER_NAME

USER $USER_NAME

WORKDIR $USER_HOME/app

FROM base as builder

ENV PIP_NO_CACHE_DIR=0
ENV POETRY_NO_INTERACTION=1
ENV POETRY_VIRTUALENVS_IN_PROJECT=1
ENV PATH=$USER_HOME/.local/bin:$PATH

RUN pip install --user poetry

COPY --chown=$USER_NAME:$USER_NAME pyproject.toml ./

RUN poetry install --only main

FROM base as runtime

ARG VENV_PATH=$USER_HOME/venv

ENV PATH=$VENV_PATH/bin:$PATH

COPY --from=builder --chown=$USER_NAME:$USER_NAME $USER_HOME/app/.venv $VENV_PATH
COPY --chown=$USER_NAME:$USER_NAME src ./

EXPOSE 8000
